<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>Linaarregressioni</title>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>

<style>

body {
  font: 14px "American Typewriter Light", Baskerville;
}

.title {
  font-size: 36px;
  text-align: center;
  margin-top: 30px;
}

svg {
  margin-left:auto;
  margin-right:auto;
  display:block;
  vertical-align: middle;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
 
</style>
</head>
<body>
<p class="title">kliki v√µi tapi ekraanil</p>
<div class="chart"></div>

<script type="text/javascript">
var margin = {top: 20, right: 20, bottom: 20, left: 20},
    width = 600 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.scale.linear()
        .range([0, width])
        .domain([-10, 10]),
    xMap = function(d) { return x(d.xc);},
    xAxis = d3.svg.axis().scale(x).orient("bottom");

var y = d3.scale.linear()
        .range([height, 0])
        .domain([-10, 10]),
    yMap = function(d) { return y(d.yc);},
    yAxis = d3.svg.axis().scale(y).orient("left"); 

var svg = d3.select(".chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    svg.append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", width)
      .attr("height", height)
      .style("fill", "#e3dac9")
      .style("opacity", 0.1)
      .style("stroke", "black");
    
  var data = [[1,1]];
  data.forEach(function(d) {
    d.xc = d["0"];
    d.yc = d["1"];
  });

  var group = svg.append("g");
  
  group.selectAll(".circles")
    .data(data)
    .enter()
    .append("circle")
    .attr("class","circles")
    .attr("r",3)
    .style("stroke","white")
    .style("opacity",1)
    .attr("cx", xMap)
    .attr("cy", yMap);
   
  svg.append("line")
    .attr("class", "trendline")
    .attr("stroke", "black")
    .attr("stroke-width", 1);

  var eqText = svg.append("text")
    .attr("id", "eq-text")
    .style("text-anchor", "start");
   
  svg.on("click",addCircle);
   
function addCircle() {
  var coords = d3.mouse(this);

  var newData= [
    x.invert(coords[0]),
    y.invert(coords[1])
  ];

  data.push(newData);

  group.selectAll(".circles")
   .data(data)
   .enter()
   .append("circle")
   .attr("class","circles")
   .attr("r",3)
   .style("stroke","white")
   .style("opacity",1)
   .attr("cx", function(d){ return x(d[0]); })
   .attr("cy", function(d){ return y(d[1]); });

  var xSeries = data.map(function(d) { return parseFloat(x(d[0])); });
  var ySeries = data.map(function(d) { return parseFloat(y(d[1])); });
  
  var leastSquaresCoeff = leastSquares(xSeries, ySeries);

  var slope = leastSquaresCoeff[0];
  var intercept = leastSquaresCoeff[1];
  var rSquare = leastSquaresCoeff[2];

  d3.selectAll(".lines")
    .transition()
    .duration(200)
    .attr("x1", function(d){ return x(d[0]) ; })
    .attr("y1", function(d){ return y(d[1]) ; })
    .attr("x2", function(d){ return x(d[0]) ; })
    .attr("y2", function(d){ return x(d[0])*slope + intercept; });

  group.selectAll(".lines")
    .data(data)
    .enter()
    .append("line")
    .attr("class", "lines")
    .attr("stroke", "black")
    .attr("stroke-width", 1)
    .attr("x1", function(d){ return x(d[0]) ; })
    .attr("y1", function(d){ return y(d[1]) ; })
    .attr("x2", function(d){ return x(d[0]) ; })
    .attr("y2", function(d){ return x(d[0])*slope + intercept; })
    .style("opacity","0.5")
    .style("stroke-dasharray", ("3, 3"));

  d3.selectAll(".trendline")
    .transition()
    .duration(200)
    .attr("x1", 0)
    .attr("y1", intercept)
    .attr("x2", width)
    .attr("y2", width*slope + intercept);

  var sign = " + ";
  if (slope>0) { sign = " - " };

  var xtextLoc = width-180,
      ytextLoc = xtextLoc*slope + intercept - 30,
      interceptLoc = y.invert((width/2)*slope + intercept);

  if (ytextLoc>height-30) { ytextLoc = height-30 };
  if (ytextLoc<30) { ytextLoc = 30 };

  d3.select('#eq-text')
    .transition()
    .duration(200)
    .attr("x", xtextLoc)
    .attr("y", ytextLoc)
    .text("y = " +  d3.round(interceptLoc, 2) + sign + Math.abs(d3.round(0-slope, 2)) + "x, r2 = " + d3.round(rSquare,2));

};

Axis();
function Axis(){
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height/2 + ")")
    .call(xAxis)
  .append("text")
    .attr("class", "label")
    .attr("x", width-7)
    .attr("y", -7)
    .style("text-anchor", "end")
    .text("x-telg");

  svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate("+ width/2 +", 0)")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 7)
      .attr("x", -7)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("y-telg");

  svg.selectAll(".y.axis").selectAll(".tick text")
      .attr("transform", "translate(-5, 0)");
  svg.selectAll(".x.axis").selectAll(".tick text")
      .attr("transform", "translate(0, 3)");
};

function leastSquares(xSeries, ySeries) {

    var reduceSumFunc = function(prev, cur) { return prev + cur; };
    
    var xBar = xSeries.reduce(reduceSumFunc) * 1.0 / xSeries.length;
    var yBar = ySeries.reduce(reduceSumFunc) * 1.0 / ySeries.length;

    var ssXX = xSeries.map(function(d) { return Math.pow(d - xBar, 2); })
      .reduce(reduceSumFunc);
    
    var ssYY = ySeries.map(function(d) { return Math.pow(d - yBar, 2); })
      .reduce(reduceSumFunc);
      
    var ssXY = xSeries.map(function(d, i) { return (d - xBar) * (ySeries[i] - yBar); })
      .reduce(reduceSumFunc);
      
    var slope = ssXY / ssXX;
    var intercept = yBar - (xBar * slope);
    var rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);
    
    return [slope, intercept, rSquare];

};
    
</script>


</body>
</html>