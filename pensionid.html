<!DOCTYPE html>
<html>
<meta charset="utf-8">

<title>Pensionifondide kalkulaator</title>

<style>
  body{
    font: 11px "San Francisco", Helvetica, Arial, sans-serif;
    background: #ededed;
  }
  svg{
    margin-left:auto;
    margin-right:auto;
    display:block;
    vertical-align: middle;
  }
  .container{

  }
  .title{
    font-size: 36px;
    text-align: center;
    margin-top: 40px;
  }
  .tick line{
    opacity: 0.2;
  }

</style>
<body>
  <p class="title">Pensionid</p>
  <div class="container" align="center">
  Vali palgaskaala ülempiir:
  <select onchange="maximumInput(this.value)">
      <option value="2000">2000€</option>
      <option value="3000">3000€</option>
      <option value="4000">4000€</option>
      <option value="5000">5000€</option>
      <option value="6000">6000€</option>
      <option value="7000">7000€</option>
      <option value="8000">8000€</option>
      <option value="9000">9000€</option>
      <option value="10000">10 000€</option>
  </select>
  </div>
  <script src="http://d3js.org/d3.v4.min.js"></script>
  <script>
    var margin = {top: 20, right: 120, bottom: 30, left: 70},
    width = 800 - margin.left - margin.right,
    height = 200 - margin.top - margin.bottom;

    var x = d3.scaleTime().range([0, width]),
    y = d3.scaleLinear().range([height, 0]),
    maxInput = 2000;

    var line = d3.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.bruto); });

    var userLine = d3.line()
    .x(function(d) { return x(d.x); })
    .y(function(d) { return y(d.y); })
    .curve(d3.curveMonotoneX);

    var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);
    var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.tsv("bruto.txt", function(error, data) {

      data.forEach(function(d,i) {
        d.date = new Date(+d.year, +d.month-1, 1);
        d.bruto = +d.bruto;
      });

      var years = [2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016],
      months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

      userInput = new Array;
      years.forEach(function(d){
        months.forEach(function(g){
          var x = new Date(+d, +g, 1);
          var y = 0;
          var defaultData= {x: x, y: y};
          userInput.push(defaultData);
        })
      });

      /*
      data.forEach(function(d){
        var x = d.date;
        var y = 0;
        var defaultData= {x: x, y: y};
        userInput.push(defaultData);
      });
      */

      x.domain(d3.extent(data, function(d) { return d.date; }));
      y.domain([0, maxInput]);

      g.append("clipPath")
      .attr("id", "box")
      .append("rect")
      .attr("width", width)
      .attr("height", height);

      g.append("path")
      .data(data)
      .attr("id", "bruto")
      .attr("d", line(data))
      .style("fill", "none")
      .style("stroke", "grey")
      .style("stroke-width", 1);

      g.append("text")
      .attr("id", "brutoText")
      .attr("y", function(){ return y(data[data.length-1].bruto)+5; })
      .attr("x", width + 5)
      .style("fill", "grey")
      .text("Keskmine bruto palk");

      g.append("path")
      .data(userInput)
      .attr("id", "userInput")
      .attr("d", userLine(userInput))
      .attr("clip-path", "url(#box)")
      .style("fill", "none")
      .style("stroke", "#CC6600")
      .style("stroke-width", 2);

      g.append("text")
      .attr("id", "userInputText")
      .attr("y", function(){ return y(0)+5; })
      .attr("x", width + 5)
      .style("fill", "#CC6600")
      .text("Sinu bruto palk");

      g.selectAll(".circles")
      .data(userInput)
      .enter()
      .append("circle")
      .attr("class", function(d,i){ return "circle" + i; })
      .attr("id", "userInputPoints")
      .attr("clip-path", "url(#box)")
      .attr("cx", function(d){return x(d.x);})
      .attr("cy", function(d){return y(d.y);})
      .attr("r", 2.5)
      .style("fill", "none")
      .style("stroke", "#CC6600")
      .style("stroke-width", 1);

      g.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).tickSize(-height,5))
      .append("text")
      .attr("class", "label")
      .attr("x", width-5)
      .attr("y", -6)
      .style("text-anchor", "end")
      .style("fill", "black")
      .text("Aeg");

      g.append("g")
      .attr("class", "y axis")
      .call(d3.axisLeft(y).tickSize(-width,5))
      .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("x", -5)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .style("fill", "black")
      .text("Bruto palk");

      g.append("text")
      .attr("class", "helper")
      .style("display", "none")
      .style("fill", "#CC6600");

      g.append("rect")
      .attr("width", width)
      .attr("height", height)
      .style("fill", "none")
      .style("pointer-events", "all")
      .on("click", dataInput)
      .on("mousemove", helper)
      .on("mouseout", helperout)
      .call(d3.drag().on("drag", dataInput));

      function helper(){
        var coords = d3.mouse(this),
        mouseDate = x.invert(coords[0]),
        dates = userInput.map(function(d) {return d.x; });

        var bisect = d3.bisector(function(d) { return d; }).left,
        i = bisect(dates, mouseDate);

        var d0 = dates[i - 1],
        d1 = dates[i],
        inputX = mouseDate - d0[0] > d1[0] - mouseDate ? d1 : d0;
        inputY = y.invert(coords[1]);

        var index = dates.indexOf(inputX);
        if(coords[0] > width - (width/(userInput.length-1))/2 ){
          var index = userInput.length - 1;
          var inputData = {x: userInput[index].x,y: inputY};
        }
        if (index !== -1) {
          g.selectAll("#userInputPoints")
          .style("fill", "none");
          g.select(".circle"+index)
          .style("fill", "#CC6600");

          g.select(".helper")
          .attr("transform", function(d){ return "translate("+ (x(userInput[index].x) - 12)  +","+ (y(userInput[index].y) - 10) +")"; })
          .style("display", "inline")
          .text(d3.format(".0f")(userInput[index].y) + "€")
        }
      }

      function helperout(){
        g.select(".helper")
        .style("display", "none")
        g.selectAll("#userInputPoints")
          .style("fill", "none");
      }

      function dataInput(){
        var coords = d3.mouse(this),
        mouseDate = x.invert(coords[0]),
        dates = userInput.map(function(d) {return d.x; });

        var bisect = d3.bisector(function(d) { return d; }).left,
        i = bisect(dates, mouseDate);

        var d0 = dates[i - 1],
        d1 = dates[i],
        inputX = mouseDate - d0[0] > d1[0] - mouseDate ? d1 : d0,
        inputY = y.invert(coords[1]);
        if(inputY > maxInput){
          var inputY = maxInput;
        } else if (inputY < 0){
          var inputY = 0;
        }

        var inputData = {x: inputX,y: inputY};

        var index = dates.indexOf(inputX);
        if(coords[0] > width - (width/(userInput.length-1))/2 ){
          var index = userInput.length - 1;
          var inputData = {x: userInput[index].x,y: inputY};
        }
        if (index !== -1) {
          userInput[index] = inputData;

          g.selectAll("#userInputPoints")
          .style("fill", "none");
          g.select(".circle"+index)
          .style("fill", "#CC6600");

          g.select(".helper")
          .attr("transform", function(d){ return "translate("+ (x(userInput[index].x) - 12)  +","+ (y(userInput[index].y) - 10) +")"; })
          .style("display", "inline")
          .text(d3.format(".0f")(userInput[index].y) + "€")
        }

        update();
      }

      maximumInput = function maximumInput(value){
        maxInput = value;
        scaleUpdate();
      }

      function update(){

        g.select("#userInput")
        .data(userInput)
        .transition()
        .duration(10)
        .attr("d", userLine(userInput));

        g.selectAll("#userInputPoints")
        .data(userInput)
        .transition()
        .duration(10)
        .attr("cx", function(d){return x(d.x);})
        .attr("cy", function(d){return y(d.y);});

        g.select("#userInputText")
        .transition()
        .duration(10)
        .attr("y", function(d){return y(userInput[userInput.length-1].y);});

      }

      function scaleUpdate(){
        y.domain([0, maxInput]);
        var time = 500;
        g.select(".y.axis")
        .transition()
        .duration(time)
        .call(d3.axisLeft(y).tickSize(-width,5));

        g.select("#bruto")
        .transition()
        .duration(time)
        .attr("d", line(data));

         g.select("#brutoText")
        .transition()
        .duration(time)
        .attr("y", function(){ return y(data[data.length-1].bruto)+5; });

        g.select("#userInput")
        .data(userInput)
        .transition()
        .duration(time)
        .attr("d", userLine(userInput));

        g.selectAll("#userInputPoints")
        .data(userInput)
        .transition()
        .duration(time)
        .attr("cx", function(d){return x(d.x);})
        .attr("cy", function(d){return y(d.y);});

        g.select("#userInputText")
        .transition()
        .duration(time)
        .attr("y", function(d){return y(userInput[userInput.length-1].y);});

      }

    });

  </script>
</body>
</html>
