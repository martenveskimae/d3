<!DOCTYPE html>
<meta charset="UTF-8">
<title>Socialia valdkonna õppekavade analüüs</title>
<style>
  body {
    background: #ededed;
    margin: 0;
    font-size: 11px;
    font-family: "San Francisco", Helvetica, Arial, sans-serif;
  }
  .container {
    margin-top: 50px;
    margin-left: 400px;
    position: relative;
  }
  #tooltip {
    color: white;
    opacity: .95;
    background: #333;
    padding: 5px;
    border: 1px solid lightgrey;
    border-radius: 5px;
    position: absolute;
    z-index: 10;
    visibility: hidden;
    pointer-events: none;
  }
  .tipper {
    position: relative;
    margin: auto;
    table-layout: fixed;
  }
  .topRow {
    font-weight: bold;
  } 
  .leftColumn {
    vertical-align: top;
    padding-left: 50px;
    text-align: right;
    font-weight: bold;
  }
  .middleColumn {
    vertical-align: top;
    width: 220px;
    text-align: left;
    word-wrap: break-word;
  }
  .rightColumn {
    vertical-align: top;
    width: 220px;
    text-align: left;
    word-wrap: break-word;
  }
  .background {
    fill: #eee;
  }
  line {
    stroke: #fff;
  }
  #legendAxis > path {
    stroke: none;
  }
  text.active {
    fill: red;
  }
  input {
    margin-left: 20px;
  }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="cubehelix.js"></script>
<div id="tooltip"></div>
<div class="container">
  <p>Järjesta: <select id="order">
    <option value="name">nime järgi</option>
    <option value="id">koodi järgi</option>
    <option value="group" selected="selected">instituudi järgi</option>
    <option value="count">kattuvuse järgi</option>
  </select>
  <input id="data" type="radio" name="dataset" value="links.txt" checked="checked">Kõik ained
  <input id="data" type="radio" name="dataset" value="links_koh.txt">Kohustuslikud ained
  <input id="data" type="radio" name="dataset" value="links_var.txt">Varjatud kattuvused
</p>
</div>

<script>
  var margin = {top: 50, right: 80, bottom: 10, left: 380},
  width = 750,
  height = 750;

  var x = d3.scaleBand().range([0, width]),
  z = d3.scaleLinear().domain([0, 4]).clamp(true),
  c = d3.scaleLinear()
  .domain([0, 1])
  .range([d3.hsl(96, .6, 1), d3.hsl(276, .6, 0)])
  .interpolate(d3.interpolateCubehelix)
  .clamp(true),
  f = d3.format(".0%");

  var svg = d3.select(".container").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .style("margin-left", -margin.left + "px")
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  d3.tsv("matrix.txt", function(data) {
    matrix = new Array,
    nodes = new Array;

    data.forEach(function(d,i) {
      nodes.push({ name: d.Õppekava, id: d.Kood, group: d.Instituut, lvl: d.Õppeaste });
    });

    n = nodes.length;

    nodes.forEach(function(node, i) {
      node.index = i;
      node.count = 0;
      node.N = 0;
      matrix[i] = d3.range(n).map(function(j) { return {x: j, y: i, z: 0, z2: 0}; });
    });

    d3.tsv("links.txt", function(error, links) {

      links.forEach(function(d) {
        matrix[d.source][d.target].z = +d.value / +d.N;
        matrix[d.source][d.target].z2 = +d.value;
        nodes[d.source].count += +d.value / +d.N;
        nodes[d.source].N += +d.N;
      });

      calculateOrders();
      x.domain(orders.group);

      svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height);

      var row = svg.selectAll(".row")
      .data(matrix)
      .enter().append("g")
      .attr("class", "row")
      .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .each( function(d) {
        var cell = d3.select(this).selectAll(".cell")
        .data(d.filter(function(d) { return d.z; }))
        .enter().append("rect")
        .attr("class", "cell")
        .attr("x", function(d) { return x(d.x); })
        .attr("width", x.bandwidth())
        .attr("height", x.bandwidth())
        .style("fill", function(d) { return c(d.z); })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout);
      });

      row.append("line")
      .attr("x2", width);

      row.append("text")
      .attr("x", -6)
      .attr("y", x.bandwidth() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "end")
      .text(function(d, i) { return nodes[i].name + " " + nodes[i].lvl; });

      var column = svg.selectAll(".column")
      .data(matrix)
      .enter().append("g")
      .attr("class", "column")
      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

      column.append("line")
      .attr("x1", -width);

      column.append("text")
      .attr("x", 6)
      .attr("y", x.bandwidth() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "start")
      .text(function(d, i) { return nodes[i].id; });

      d3.select("#order").on("change", function() {
        order(this.value);
      });

      d3.selectAll("#data").on("click", function() {
        switchData(this.value);
      });

      function switchData(dataset) {

        d3.tsv(dataset, function(error, links) {

        nodes.forEach(function(node) { node.count = 0; });

          links.forEach(function(d) {
            matrix[d.source][d.target].z = +d.value / +d.N;
            matrix[d.source][d.target].z2 = +d.value;
            nodes[d.source].count += +d.value / +d.N;
            nodes[d.source].N += +d.N;
          });

          calculateOrders();
          var e = document.getElementById("order");
          var orderValue = e.options[e.selectedIndex].value;
          order(orderValue);

          var row = svg.selectAll(".row")
          .data(matrix)
          .each(function (d) {
            d3.select(this).selectAll(".cell")
            .data(d.filter(function(d) { return d.z; }))
            .transition()
            .duration(2000)
            .attr("x", function(d) { return x(d.x); })
            .style("fill", function(d) { return c(d.z); });

            d3.select(this).selectAll(".cell")
            .data(d.filter(function(d) { return d.z; }))
            .enter().append("rect")
            .attr("class", "cell")
            .attr("x", function(d) { return x(d.x); })
            .attr("width", x.bandwidth())
            .attr("height", x.bandwidth())
            .style("fill", function(d) { return c(d.z); })
            .on("mouseover", mouseover)
            .on("mouseout", mouseout);

            d3.select(this).selectAll(".cell")
            .data(d.filter(function(d) { return d.z; }))
            .exit()
            .remove();
          });
        });
      };

      function calculateOrders(){
        orders = {
          name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].name, nodes[b].name); }),
          id: d3.range(n).sort(function(a, b) { return nodes[b].id - nodes[a].id; }),
          count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; }),
          group: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].group, nodes[b].group); })
        };
      }

      function order(value) {
        x.domain(orders[value]);
        var t = d3.transition().duration(2000);

        t.selectAll(".row")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
        .selectAll(".cell")
        .delay(function(d) { return x(d.x) * 4; })
        .attr("x", function(d) { return x(d.x); });

        t.selectAll(".column")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
      }
    });
  });

  svg.append("defs")
  .append("linearGradient")
  .attr("id", "gradient")
  .attr("x1", "0%").attr("y1", "100%")
  .attr("x2", "0%").attr("y2", "0%")
  .selectAll("stop") 
  .data(d3.range(10))                
  .enter().append("stop") 
  .attr("offset", function(d,i) { 
    return (i/10);
  })   
  .attr("stop-color", function(d,i) { 
    return c(i/10); 
  });

  svg.append("rect")
  .attr("class", "legendRect")
  .attr("x", width + 18)
  .attr("y", 0)
  .attr("width", 12)
  .attr("height", 200)
  .style("fill", "url(#gradient)");

  var legendY = d3.scaleLinear()
   .rangeRound([199,0])
   .domain([0, 1]);

  svg.append("g")
  .attr("id", "legendAxis")
  .attr("transform", function(d) { return "translate(" + (width + 30) + ",0)"; })
  .call(d3.axisRight(legendY).ticks(10 ,"%").tickSize(0,0));

  function mouseover(p) {
    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
    d3.select("#tooltip")
    .style("visibility", "visible")
    .html("<table class='tipper'><tr class='topRow'><td></td><td>Mis?</td><td>Millega?</td></tr><tr><td class='leftColumn'>Õppekava:</td><td class='middleColumn'>" +
      nodes[p.y].name + "</td><td class='rightColumn'>" + nodes[p.x].name + "</td></tr><td class='leftColumn'>Õppeaste:</td><td class='middleColumn'>" +
      nodes[p.y].lvl + "</td><td class='rightColumn'>" + nodes[p.x].lvl + "</td></tr><td class='leftColumn'>Instituut:</td><td class='middleColumn'>" +
      nodes[p.y].group + "</td><td class='rightColumn'>" + nodes[p.x].group + "</td></tr><td class='leftColumn'>Kattuvus:</td><td class='middleColumn'>" +
      f(p.z) + " (kattuvaid aineid: " + p.z2 + ")</td><td class='rightColumn'></td></tr></table>")
    .style("top", function () { return (d3.event.pageY - 130)+"px"})
    .style("left", function () { return (d3.event.pageX - 270)+"px";});
  }

  function mouseout() {
    d3.selectAll("text").classed("active", false);
    d3.select("#tooltip").style("visibility", "hidden");
  }

</script>

