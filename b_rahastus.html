<!DOCTYPE html>
<html>
<meta charset="utf-8">

<title>Erakondade rahastamine</title>

<style>

body {
  font: 12px "American Typewriter Light", Baskerville;
}

.voronoi path {
  fill: none;
  pointer-events: all;
}

.title {
  font-size: 36px;
  text-align: center;
  margin-top: 30px;
}

.tick line{
  opacity: 0.2;
 }

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

svg {
  margin-left:auto;
  margin-right:auto;
  display:block;
  vertical-align: middle;
}

.legendBox{
  fill:white;
  stroke:black;
}

.legend rect {
  stroke: black;
}

.tooltip {
    font-size: 30px;
    position: absolute;
    top: 200px;
    left: 60%;
    text-align: left;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.js"></script>
<p class="title">Erakondade rahastamine 2014Q1 - 2015Q4</p>
<div class="chart"></div>

<script>
var EST = d3.locale({
  "decimal": ".",
  "thousands": ",",
  "grouping": [3],
  "currency": ["$", ""],
  "dateTime": "%a %b %e %X %Y",
  "date": "%m-%d-%Y",
  "time": "%H:%M:%S",
  "periods": ["AM", "PM"],
  "days": ["Pühapäev", "Esmaspäev", "Teisipäev", "Kolmapäev", "Neljapäev", "Reede", "Laupäev"],
  "shortDays": ["Pühap", "Esmasp", "Teisip", "Kolmap", "Neljap", "Reede", "Laup"],
  "months": ["Jaanuar", "Veebruar", "Märts", "Aprill", "Mai", "Juuni", "Juuli", "August", "September", "Oktoober", "November", "Detsember"],
  "shortMonths": ["Jan", "Veeb", "Märts", "Apr", "Mai", "Juun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dets"]
});

chart("b_rahastus.csv", "party");

var partyShow = [true, true, true, true];
var partyArray = ["kesk", "ref", "irl", "sde"];
var datearray = [];
var colorrange = [];

function chart(csvpath, color) {
if (color == "blue") {
  colorrange = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
  }
  else if (color == "pink") {
  colorrange = ["#980043", "#DD1C77", "#DF65B0", "#C994C7", "#D4B9DA", "#F1EEF6"];
  }
  else if (color == "party") {
  colorrange = ["#109618", "#ff9900", "#3366cc", "#dc3912"];
  }
  else if (color == "orange") {
  colorrange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"];
  };

strokecolor = colorrange[0];
strokecolor2 = function (d, i) { return z(i);};

var format = d3.time.format("%m/%d/%y");

var margin = {top: 50, right: 20, bottom: 60, left: 80},
    width = 1200 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var z = d3.scale.ordinal()
    .range(colorrange);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(10)
    .tickSize(-width, 0, 4);

var xAxis1 = d3.svg.axis()
    .scale(x)
    .tickFormat(EST.timeFormat("%B"))
    .tickSize(5,0)
    .orient("bottom")
    .ticks(10)
    .tickSize(-height, 0, 4);

var xAxis2 = d3.svg.axis()
    .scale(x)
    .ticks(d3.time.years, 1)
    .tickFormat(d3.time.format("%Y"))
    .tickSize(5,0)
    .orient("bottom");

var nest = d3.nest()
    .key(function(d) { return d.party; });

var area = d3.svg.area()
    .interpolate("cardinal")
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(0); })
    .y1(function(d) { return y(d.value); });

var voronoi = d3.geom.voronoi()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.value); })
    .clipExtent([[0, 0], [width, height]]);

var svg = d3.select(".chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    svg.append("rect")
      .attr("x", 0)
      .attr("y",-0.5)
      .attr("width", width+0.5)
      .attr("height", height)
      .style("fill", "#e3dac9")
      .style("opacity", 0.1);

var graph = d3.csv(csvpath, function(data) {
  var flatData = [];
  data.forEach(function(d) {
    d.date = new Date(+d.year, +d.month-1, 1);
    d.membership = +d.membership;
    d.donation = +d.donation;
    d.government = +d.government;
    d.loan = +d.loan;
    d.private = d.donation+d.membership;
    d.sum = +d.total;
    d.exp = +d.exp;
    d.balance = +d.balance;
    d.party = d.party;
    d.value = d.balance;
    flatData.push({date: d.date, value: d.value, key: "value", party: d.party});
    //console.log(d);
  });

  x.domain(d3.extent(data, function(d) { return d.date; }));
  y.domain([d3.min(data, function(d) { return d.value; })-200000, d3.max(data, function(d) { return d.value; })+100000]);

Axis();

    svg.append("clipPath")
      .attr("id", "rectClip")
      .append("rect")
      .attr("width", 0)
      .attr("height", height);

    svg.selectAll(".layer")
      .data(nest.entries(data))
      .enter()
      .append("g")
      .attr("class", "layer")
      .append("path")
      .attr("class", "paths")
      .attr("id", function (d) { return d.key; })
      .attr("data-legend", function (d) { return d.key; })
      .attr("clip-path", "url(#rectClip)")
      .style("stroke-width", "1.5px")
      .style("stroke", "black")
      .style("opacity", 1) 
      .call(function(d) {
         d3.select("#rectClip rect")
         .transition().duration(3000)
         .attr("width", 1200);
      });

  var focus = svg.append("g")
      .attr("class", "focus")
      .style("display", "none");

  focus.append("circle")
      .attr("r", 4.5)
      .style("fill", "none")
      .style("stroke", "black");

  focus.append("text")
      .attr("x", 9)
      .attr("dy", ".35em")
      .style("font-size", "12");

  var voronoiGroup = svg.append("g")
      .attr("class", "voronoi");

  voronoiGroup.selectAll(".paths")
      .data(voronoi(flatData))
      .enter().append("path")
      .attr("id", function(d) { return d.point[1]; })
      .attr("d", function(d) { return "M" + d.join("L") + "Z"; })
      .datum(function(d) { return d.point; })
      .on("mouseover", mouseover)
      .on("mouseout", mouseout);

  function mouseover(d) {
    d3.select("."+d.key);
    focus.transition()
    .style("display", "inline")
    .attr("transform", "translate(" + x(d.date) + "," + y(d.value) + ")");
    focus.select("text")
    .attr("transform", "translate(-20,0)")
    .style("text-anchor", "end")
    .text(d.party+": "+d.value+"€");
  }
  
  function mouseout(d) {
    d3.select("."+d.key);
    focus.transition()
    .duration(1000)
    .style("display", "none");
  }

var legendBox = svg.selectAll(".legendBox")
    .data(["1"])
    .enter();

  legendBox.append("rect")
    .attr("x", width - 90)
    .attr("y", 5)
    .attr("width", 80)
    .attr("height", 125)
    .attr("class", "legendBox");
      
  legendBox.append("text")
    .attr("x", width-100)
    .attr("y", 70)
    .attr("class", "help")
    .style("text-anchor", "end")
    .style("font-size", 15)
    .html("Siin saab erakondi sisse ja välja lülitada!");

help();
function help() {
  d3.selectAll(".help")
      .transition()
      .duration(2000)
      .style("opacity", 0); 
};
    
var legend = svg.selectAll(".legend")
    .data(partyArray, function(d, i) { return d + i; })
    .enter()
    .append("g")
    .attr("class", "legend")
    .attr("transform", function(d, i) { return "translate(0,"+ i * 30 +")"; });

  legend.append("rect")
    .attr("id", function (d) { return d+"Legend"; })
    .attr("x", width - 40)
    .attr("y", 10)
    .attr("width", 25)
    .attr("height", 25)
    .style("fill", function (d) { return "url(#"+ d +"Pattern) #fff"; })
    .on("click", function (d, i) { 
      if (!partyShow[i]) {
      restore(d);
      } else {
      remove(d);
      }
      partyShow[i] =! partyShow[i];
      });

  legend.append("text")
    .text(function (d) { return d; })
    .attr("x", width - 45)
    .attr("y", 21)
    .attr("dy", ".35em")
    .style("text-anchor", "end");

partyArray.forEach(function (d, i) { return initiate(partyArray[i]);});
function initiate(target){

d3.selectAll("#"+target)
    .data(nest.entries(data).filter(function (d) { return d.key === target }))
    .attr("d", function(d) { return area(d.values); })
    .style("fill", "url(#"+target+"Pattern) #fff");
};

function restore(target) {
  d3.selectAll("#"+target)
    .data(nest.entries(data).filter(function (d) { return d.key === target }))
    .attr("d", function(d) { return area(d.values); });

  svg.selectAll("#"+target+"Legend")
    .style("fill", "url(#"+ target +"Pattern) #fff");
}

function remove(target) {

    svg.selectAll("#"+target)
      .attr("d", null);

    svg.selectAll("#"+target+"Legend")
      .style("fill", "white");

};

function Axis(){
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis1);
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + (height+25) + ")")
    .call(xAxis2);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("x", -7)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Bilanss eurodes");

    svg.selectAll(".y.axis").selectAll(".tick text")
      .attr("transform", "translate(-5, 0)");
    svg.selectAll(".x.axis").selectAll(".tick text")
      .attr("transform", "translate(0, 3)");
};

});
};
</script>
<svg height="10" width="10" xmlns="http://www.w3.org/2000/svg" version="1.1"> <defs> <pattern id="refPattern" patternUnits="userSpaceOnUse" width="10" height="10"> <image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+CiAgPHJlY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJyBmaWxsPSJ3aGl0ZSIgLz4KICA8Y2lyY2xlIGN4PSIxIiBjeT0iMSIgcj0iMSIgZmlsbD0iYmxhY2siLz4KPC9zdmc+" x="0" y="0" width="10" height="10"> </image> </pattern> </defs> </svg>
<svg height="10" width="10" xmlns="http://www.w3.org/2000/svg" version="1.1"> <defs> <pattern id="keskPattern" patternUnits="userSpaceOnUse" width="10" height="10"> <image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+CiAgPHJlY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJyBmaWxsPSd3aGl0ZScvPgogIDxwYXRoIGQ9J00tMSwxIGwyLC0yCiAgICAgICAgICAgTTAsMTAgbDEwLC0xMAogICAgICAgICAgIE05LDExIGwyLC0yJyBzdHJva2U9J2JsYWNrJyBzdHJva2Utd2lkdGg9JzEnLz4KPC9zdmc+Cg==" x="0" y="0" width="10" height="10"> </image> </pattern> </defs> </svg>
<svg height="8" width="8" xmlns="http://www.w3.org/2000/svg" version="1.1"> <defs> <pattern id="irlPattern" patternUnits="userSpaceOnUse" width="8" height="8"> <image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4JyBoZWlnaHQ9JzgnPgogIDxyZWN0IHdpZHRoPSc4JyBoZWlnaHQ9JzgnIGZpbGw9JyNmZmYnLz4KICA8cGF0aCBkPSdNMCAwTDggOFpNOCAwTDAgOFonIHN0cm9rZS13aWR0aD0nMC41JyBzdHJva2U9JyNhYWEnLz4KPC9zdmc+Cg==" x="0" y="0" width="8" height="8"> </image> </pattern> </defs> </svg>
<svg height="10" width="10" xmlns="http://www.w3.org/2000/svg" version="1.1"> <defs> <pattern id="sdePattern" patternUnits="userSpaceOnUse" width="10" height="10"> <image xlink:href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMTAnIGhlaWdodD0nMTAnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+CiAgPHBhdGggZD0nTTAgMEw0IDQnIHN0cm9rZT0nI2FhYScgZmlsbD0nI2FhYScgc3Ryb2tlLXdpZHRoPScxJy8+CiAgPHBhdGggZD0nTTIuNSAwTDUgMi41TDUgNUw5IDlMNSA1TDEwIDVMMTAgMCcgc3Ryb2tlPScjYWFhJyBmaWxsPScjYWFhJyBzdHJva2Utd2lkdGg9JzEnLz4KICA8cGF0aCBkPSdNNSAxMEw1IDcuNUw3LjUgMTAnIHN0cm9rZT0nI2FhYScgZmlsbD0nI2FhYScgc3Ryb2tlLXdpZHRoPScxJy8+Cjwvc3ZnPgo=" x="0" y="0" width="10" height="10"></image></pattern></defs></svg>
</body>
</html>
