<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>Linear regression</title>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="distributions.js"></script>
<style>

body {
  font: 12px "American Typewriter Light", Baskerville;
}

.title {
  font-size: 36px;
  text-align: center;
  margin-top: 30px;
}

table {
  margin-left:auto;
  margin-right:auto;
  display:block;
  vertical-align: middle;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
  stroke-dasharray: 2,2;
}
.buttonDiv {
  text-align: center;
}
button {
    background-color: null;
    border: none;
    color: white;
    padding: 12px 25px;
    border-radius: 5px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font: 16px "American Typewriter Light", Baskerville;
}
button:hover {
  background-color: #666666;
}

#table {
  font: 15px "American Typewriter Light", Baskerville;
}
 
</style>
</head>
<body>
<p class="title">Click or tap on the graph</p>
<table width="900"><tr><td>
<div class="chart"></div>
</td><td>
<div class="table"></div>
<div class="buttonDiv"><button onclick="random()">Randomize</button></div>
</td></tr></table>
<script type="text/javascript">
var margin = {top: 20, right: 20, bottom: 20, left: 20},
    width = 700 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

f=d3.format(".3f");

var x = d3.scale.linear()
        .range([0, width])
        .domain([-5, 5]),
    xMap = function(d) { return x(d.x);},
    xAxis = d3.svg.axis().scale(x).orient("bottom");

var y = d3.scale.linear()
        .range([height, 0])
        .domain([-5, 5]),
    yMap = function(d) { return y(d.y);},
    yAxis = d3.svg.axis().scale(y).orient("left");

var line = d3.svg.line() 
  .interpolate("monotone")
  .x(function(d) { return x(d.x); })
  .y(function(d) { return y(d.y); });

var marginValue = [-5, 0, 5];

var svg = d3.select(".chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    svg.append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", width)
      .attr("height", height)
      //.style("fill", "#e3dac9")
      .style("opacity", 0.00)
      .style("stroke", "black");
   
  var data = [{x: 1, y: 1}];

  var group = svg.append("g");
  
  group.selectAll(".circles")
    .data(data)
    .enter()
    .append("circle")
    .attr("class","circles")
    .attr("r",3)
    .style("stroke","black")
    .style("fill", "none")
    .style("opacity",1)
    .attr("cx", xMap)
    .attr("cy", yMap);

  svg.append("path")
    .attr("class", "upper")
    .style("fill", "none")
    .attr("stroke", "navy")
    .attr("stroke-width", 1.2)
    .style("stroke-dasharray", (3, 3));

  svg.append("path")
    .attr("class", "lower")
    .style("fill", "none")
    .attr("stroke", "navy")
    .attr("stroke-width", 1.2)
    .style("stroke-dasharray", (3, 3));

  svg.append("line")
    .attr("class", "trendline")
    .attr("stroke", "navy")
    .attr("stroke-width", 1.2);

  svg.append("line")
    .attr("class", "helperH")
    .attr("stroke", "#DC143C")
    .attr("stroke-width", 1.2)
    .style("stroke-dasharray", (3, 3));

  svg.append("text")
    .attr("class", "helperTextH")
    .style("fill", "#DC143C");

  svg.append("text")
    .attr("class", "helperTextV")
    .style("fill", "#DC143C");

  svg.append("line")
    .attr("class", "helperV")
    .attr("stroke", "#DC143C")
    .attr("stroke-width", 1.2)
    .style("stroke-dasharray", (3, 3));

  var eqText = svg.append("text")
    .attr("id", "eq-text")
    .style("fill", "#DC143C")
    .style("text-anchor", "start");
   
  svg.on("click",addCircle);
  var margin = 0; 

function addCircle() {
  var coords = d3.mouse(this);

  var newData= {x: x.invert(coords[0]),y: y.invert(coords[1])};

  data.push(newData);

  update();
};

function update(){

  group.selectAll(".circles")
   .data(data)
   .transition()
   .duration(200)
   .delay(function(d, i) { return i * 5; })
   .attr("cx", function(d){ return x(d.x); })
   .attr("cy", function(d){ return y(d.y); });

  group.selectAll(".circles")
   .data(data)
   .enter()
   .append("circle")
   .attr("class","circles")
   .attr("r",3)
   .style("stroke","black")
   .style("fill", "none")
   .style("opacity",1)
   .attr("cx", function(d){ return x(d.x); })
   .attr("cy", function(d){ return y(d.y); });

  group.selectAll(".circles")
   .data(data)
   .exit()
   .remove();

  var xSeries = data.map(function(d) { return parseFloat(x(d.x)); });
  var ySeries = data.map(function(d) { return parseFloat(y(d.y)); });
  
  var leastSquaresCoeff = leastSquares(xSeries, ySeries);

  var slope = leastSquaresCoeff[0];
  var intercept = leastSquaresCoeff[1];
  var rSquare = leastSquaresCoeff[2];

  var ciCapWidth = 10;

  d3.selectAll(".lines")
    .data(data)
    .transition()
    .duration(200)
    .delay(function(d, i) { return i * 5; })
    .attr("x1", function(d){ return x(d.x) ; })
    .attr("y1", function(d){ return y(d.y) ; })
    .attr("x2", function(d){ return x(d.x) ; })
    .attr("y2", function(d){ return x(d.x)*slope + intercept; });

  group.selectAll(".lines")
    .data(data)
    .enter()
    .append("line")
    .attr("class", "lines")
    .attr("stroke", "black")
    .attr("stroke-width", 1)
    .attr("x1", function(d){ return x(d.x) ; })
    .attr("y1", function(d){ return y(d.y) ; })
    .attr("x2", function(d){ return x(d.x) ; })
    .attr("y2", function(d){ return x(d.x)*slope + intercept; })
    .style("opacity",0.1)
    .style("stroke-dasharray", (3, 3));

  group.selectAll(".lines")
    .data(data)
    .exit()
    .remove();

  svg.select(".upper")
    .transition()
    .duration(200)
    .attr("d", function(d){ return line(upper3); });

  svg.select(".lower")
    .transition()
    .duration(200)
    .attr("d", function(d){ return line(lower3); });

  d3.selectAll(".trendline")
    .transition()
    .duration(200)
    .attr("x1", 0)
    .attr("y1", intercept)
    .attr("x2", width)
    .attr("y2", height*slope + intercept);

  d3.selectAll(".helperH")
    .transition()
    .duration(200)
    .attr("x1", x(1))
    .attr("y1", x(1)*slope + intercept)
    .attr("x2", x(2.2))
    .attr("y2", x(1)*slope + intercept)
  
  var hLoc = x(1)*slope + intercept + 13;
  if (slope>0) { hLoc = x(1)*slope + intercept - 7 };

  d3.selectAll(".helperTextH")
    .transition()
    .duration(200)
    .attr("x", x(1.5)-7)
    .attr("y", hLoc)
    .text("x = 1");

  d3.selectAll(".helperV")
    .transition()
    .duration(200)
    .attr("x1", x(2))
    .attr("y1", x(2)*slope + intercept)
    .attr("x2", x(2))
    .attr("y2", x(0.8)*slope + intercept);

  var sign = " + ";
  if (slope>0) { sign = " - " };

  d3.selectAll(".helperTextV")
    .transition()
    .duration(200)
    .attr("x", x(2)+13)
    .attr("y", x(1.5)*slope + intercept)
    .text("y =" + sign + Math.abs(f(0-slope)));


  var xtextLoc = width-100,
      ytextLoc = xtextLoc*slope + intercept - 30,
      interceptLoc = y.invert((width/2)*slope + intercept);

  if (ytextLoc>height-30) { ytextLoc = height-30 };
  if (ytextLoc<30) { ytextLoc = 30 };
  d3.select('#eq-text')
    .transition()
    .duration(200)
    .attr("x", xtextLoc)
    .attr("y", ytextLoc)
    .text("y = " +  f(interceptLoc) + sign + Math.abs(f(0-slope)) + "x");

  tableStats(interceptLoc, 0-slope, rSquare)
};

Axis()
function Axis(){
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height/2 + ")")
    .call(xAxis)
  .append("text")
    .attr("class", "label")
    .attr("x", width-7)
    .attr("y", -7)
    .style("text-anchor", "end")
    .text("x-axis");

  svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate("+ width/2 +", 0)")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 7)
      .attr("x", -7)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("y-axis");

  svg.selectAll(".y.axis").selectAll(".tick text")
      .attr("transform", "translate(-5, 0)");
  svg.selectAll(".x.axis").selectAll(".tick text")
      .attr("transform", "translate(0, 3)");
};

function number (n) {
  function range(obj){
      if (obj.x < n+1.25 && obj.x > n-1.25) {
        return true;
      }
  }
  if (data.filter(range).length < 1) {
    return 0.5; } else {
    return data.filter(range).length;  
  };
};

function leastSquares(xSeries, ySeries) {

    upper3 = [0];
    lower3 = [0];

    var reduceSumFunc = function(prev, cur) { return prev + cur; };
    
    var xBar = xSeries.reduce(reduceSumFunc) * 1.0 / xSeries.length;
    var yBar = ySeries.reduce(reduceSumFunc) * 1.0 / ySeries.length;

    var ssXX = xSeries.map(function(d) { return Math.pow(d - xBar, 2); })
      .reduce(reduceSumFunc);
    
    var ssYY = ySeries.map(function(d) { return Math.pow(d - yBar, 2); })
      .reduce(reduceSumFunc);
      
    var ssXY = xSeries.map(function(d, i) { return (d - xBar) * (ySeries[i] - yBar); })
      .reduce(reduceSumFunc);
  

    ////////////////////////////////////////////////

    function stdDevPopulation(dataSet) {
      var mn = d3.mean(dataSet);
      var stddev = Math.sqrt(d3.sum(dataSet, function(d) {return Math.pow(d - mn, 2);}) / (dataSet.length-1));
      return stddev;
    };

    function stdDevSample(dataSet) {
      var mn = d3.mean(dataSet);
      var stddev = Math.sqrt(d3.sum(dataSet, function(d) {return Math.pow(d - mn, 2);}) / (dataSet.length-2));
      return stddev;
    };

    function variance(dataSet) {
      var mn = d3.mean(dataSet);
      var varp = dataSet.map(function(d) { return Math.pow(d - mn, 2); });
      return d3.sum(varp) / (dataSet.length-1);
    };

    function seMean(xPos) {
      var seMean1 = s / Math.sqrt(n) * Math.sqrt(1 + (Math.pow(xPos - meanX, 2) / variance(invertedxSeries)));
      return seMean1;
    };

        invertedxSeries = xSeries.map(function(d) { return x.invert(d); }),
        invertedySeries = ySeries.map(function(d) { return y.invert(d); }),
        n = data.length,
        meanY = d3.mean(invertedySeries),
        stddevY = stdDevSample(invertedySeries),
        meanX = d3.mean(invertedxSeries),
        stddevX = stdDevSample(invertedxSeries),
        ///////////////////////////////////////
        rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY),
        correlation = Math.sqrt(rSquare),
        AdjRSquared = 1 - ((n - 1) / (n - 2)) * (1 - rSquare),
        seReg = Math.sqrt(1 - AdjRSquared) * stddevY,
        ///////////////////////////////////////
        slope = ssXY / ssXX,
        seSlope = seReg / Math.sqrt(n) * (1 / stdDevPopulation(invertedxSeries)),
        tStatSlope = (0 - slope) / seSlope,
        pValueSlope = 2 * (1 - tFunction((n-2), Math.abs(tStatSlope))),
        intercept = yBar - (xBar * slope),
        seIntercept = seReg / Math.sqrt(n) * Math.sqrt( 1 + Math.pow(meanX, 2) / variance(invertedxSeries)),
        tStatIntercept = y.invert((width/2)*slope + intercept) / seIntercept,
        pValueIntercept = 2 * (1 - tFunction((n-2), Math.abs(tStatIntercept))),

        //p = 2 ∗ (1 − T (df, |t|))
        ///////////////////////////////////////
        confLevel = 0.95,
        criticalTValue = function(df) {
          if (n < 6) { return "Too few data"; }
          else { return tdistr((n - 2), (1 - confLevel)) };
        },
        ///////////////////////////////////////
        forecastX = function(xLoc) { return y.invert(x(xLoc) * slope + intercept); },
        seMeanAtX = function(xLoc) { return seReg / Math.sqrt(n) * Math.sqrt(1 + Math.pow(xLoc - meanX, 2) / variance(invertedxSeries)); },
        lowerConfLimit = function(xLoc) { return forecastX(xLoc) - (criticalTValue() * seMeanAtX(xLoc)) },
        upperConfLimit = function(xLoc) { return forecastX(xLoc) + (criticalTValue() * seMeanAtX(xLoc)) },
        ///////////////////////////////////////
        l1 = lowerConfLimit(-5),
        l2 = lowerConfLimit(0),
        l3 = lowerConfLimit(5),
        u1 = upperConfLimit(-5),
        u2 = upperConfLimit(0),
        u3 = upperConfLimit(5);

    console.log(data,
                "n: " + n,
                "mean of Y: " + meanY,
                "stddev of Y: " + stddevY,
                "mean of X: " + meanX,
                "stddev of X: " + stddevX,
                "correlation: " + correlation,
                "r squared: " + rSquare,
                "adj r squared: " + AdjRSquared,
                "se of regression: " + seReg,
                "slope: " + (0-slope),
                "se of slope: " + seSlope,
                "t-stat of slope: " + tStatSlope,
                "p-value of slope: " + pValueSlope,
                "intercept: " + y.invert((width/2)*slope + intercept),
                "se of intercept: " + seIntercept,
                "t-stat of intercept: " + tStatIntercept,
                "p-value of intercept: " + pValueIntercept);

    upper3 =  [{ y:u1, x:-5 }, { y:u2, x:0 }, { y:u3, x:5 }];
    lower3 =  [{ y:l1, x:-5 }, { y:l2, x:0 }, { y:l3, x:5 }];

    /*
    var RSS = xSeries.map(function(d,i) { return Math.pow(y.invert(ySeries[i]) - y.invert(d * slope + intercept), 2); });
        //ESS = xSeries.map(function(d,i) { return Math.pow(y.invert(d * slope + intercept) - meanY, 2); });
        //errors = xSeries.map(function(d,i) { return y.invert(ySeries[i]) - y.invert(d * slope + intercept); });
    var s = Math.sqrt(d3.sum(RSS) / (n-2));
        //s2 = stdDevSample(errors) * Math.sqrt((n-1)/(n-2));

    seIntercept = s / Math.sqrt(n) * Math.sqrt(1 + (Math.pow(meanX, 2) / variance(invertedxSeries)));

    seSlope = s / Math.sqrt(n) * (1 / stdDevPopulation(invertedxSeries));

    var tValue = function(df) {
      if (n<6) { return "Too few data"; }
      else { return tdistr(n-2, 0.005) };
    };
    */
    
    return [slope, intercept, rSquare];
};
function ci95(p, n) {
    return Math.sqrt(Math.abs(p*(1-p)/n)*1.96);
};

function random(){
  data.length = 0;
  for (i=0;i<100;i++){
    var rndX = d3.random.normal(0, 2);
    var rndY = d3.random.normal(0, 1);
    var randomX = rndX(),
        randomY = rndY();

    data.push({x: randomX, y: randomY});
  }
  update();
};

table()
function table() {
  var width = 300;
  var height = 300;
  var svg = d3.select(".table").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g");

svg.append("text")
  .attr("x", 40)
  .attr("y", 15)
  .attr("id", "table")
  .text("Table 1. Interactive regression model");

svg.append("line")
  .attr("x1", 0)
  .attr("x2", width)
  .attr("y1", 30)
  .attr("y2", 30)
  .style("stroke", "black")
  .style("stroke-width", 1.5);

svg.append("text")
  .attr("x", width/2-20)
  .attr("y", 50)
  .attr("id", "table")
  .attr("text-anchor", "end")
  .text("Variable x");

svg.append("text")
  .attr("x", width/2+20)
  .attr("y", 50)
  .attr("id", "table")
  .attr("class", "slope")
  .attr("text-anchor", "beginning");

svg.append("text")
  .attr("x", width/2+20)
  .attr("y", 70)
  .attr("id", "table")
  .attr("class", "slopeD")
  .attr("text-anchor", "beginning");

svg.append("text")
  .attr("x", width/2-20)
  .attr("y", 90)
  .attr("id", "table")
  .attr("text-anchor", "end")
  .text("Constant");

svg.append("text")
  .attr("x", width/2+20)
  .attr("y", 90)
  .attr("class", "intercept")
  .attr("id", "table")
  .attr("text-anchor", "beginning");

svg.append("text")
  .attr("x", width/2+20)
  .attr("y", 110)
  .attr("class", "interceptD")
  .attr("id", "table")
  .attr("text-anchor", "beginning");

svg.append("text")
  .attr("x", width/2-20)
  .attr("y", 170)
  .attr("id", "table")
  .attr("text-anchor", "end")
  .text("N");

svg.append("text")
  .attr("x", width/2+20)
  .attr("y", 170)
  .attr("class", "num")
  .attr("id", "table")
  .attr("text-anchor", "beginning");

svg.append("text")
  .attr("x", width/2-20)
  .attr("y", 150)
  .attr("id", "table")
  .attr("text-anchor", "end")
  .text("r-sqr");

svg.append("text")
  .attr("x", width/2+20)
  .attr("y", 150)
  .attr("class", "R")
  .attr("id", "table")
  .attr("text-anchor", "beginning");

svg.append("line")
  .attr("x1", 0)
  .attr("x2", width)
  .attr("y1", 185)
  .attr("y2", 185)
  .style("stroke", "black")
  .style("stroke-width", 1.5);

svg.append("text")
  .attr("x", 10)
  .attr("y", 205)
  .text("*p<0.05, ** p<0.01, ***p<0.001");

};

function tableStats(intercept, slope, R){

d3.selectAll(".slope")
  .text(function(d) {
    if (pValueSlope > 0.05) { return f(slope); }
    else if (pValueSlope > 0.01 && pValueSlope <= 0.05) { return f(slope) + "*"; }
    else if (pValueSlope > 0.001 && pValueSlope <= 0.01) { return f(slope) + "**"; }
    else if (pValueSlope <= 0.001) { return f(slope) + "***"; }
  });

d3.selectAll(".intercept")
  .text(function(d) {
    if (pValueIntercept > 0.05) { return f(intercept); }
    else if (pValueIntercept > 0.01 && pValueIntercept <= 0.05) { return f(intercept) + "*"; }
    else if (pValueIntercept > 0.001 && pValueIntercept <= 0.01) { return f(intercept) + "**"; }
    else if (pValueIntercept <= 0.001) { return f(intercept) + "***"; }
  });

d3.selectAll(".interceptD")
  .text("(" + f(seIntercept) + ")");

d3.selectAll(".slopeD")
  .text("(" + f(seSlope) + ")");

d3.selectAll(".num")
  .text(data.length);

d3.selectAll(".R")
  .text(f(R));

}

</script>


</body>
</html>